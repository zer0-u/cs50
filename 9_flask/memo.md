# 0414

## 講義動画
- これまで学んできた言語を組み合わせる
- まだAndroidがKotlinじゃなくてJavaの時代らしい
  - 2021年なのに？
  - KotlinもJavaに含めているのかな
- http-serverは無償なのでちょっと機能が弱い
  - クライアントサイドに完結した処理はできるがサーバサイドとの連携はできない
  - 別のツールを後ほど紹介する
- ルーティング
  - 特定のフォルダやサイトを参照しないURLのあり方
- 先週までのツールではクエリパラメータを解析できなかった
  - 追加できても読み取れない
- pythonで構築されたWebサーバを使うとパスパラメータが使えるようになる
  - dictオブジェクトに変換してくれる
- フレームワークを使う
  - 誰かが書いたライブラリの束
  - 物事を行うための一連の規則
  - bootstrapもフレームワークの一種
- flaskはpythonのフレームワーク
  - パスパラメータ解析やメール送信などが簡単にできる
- flaskを利用する
  - from flask import Flask
- flaskの規則
  - ルートディレクトリにapp.py, requirements.txt, staticディレクトリ, templatesディレクトリが必要
  - requirements.txtは参照したいライブラリの名前を列挙したテキストファイル
  - staticディレクトリには画像やCSSなど静的コンテンツを入れる
  - templatesディレクトリはHTMLを入れる
  - これはflaskの慣習
    - フレームワークが変われば慣習も変わる

## 講義動画(8:47)
- Webアプリケーションを作ってみる(helloフォルダ)
- pythonのコメントは `//` でなく#だと忘れていた
- app.py→index.html
- 静的ファイルがないのでstaticsは不要
- requirements.txtはシンプルなものでいいと言っているが具体的な手順は不明
- 起動する
  - http-serverはapp.pyの中身をそのまま表示する
  - flask runで実行(必要なものは事前のインストール済)
- requrements.txtは今のところつくらなくていいらしい
- flaskはデフォルトでポート5000を使う
- URLの末尾に「/?name=david」を足してみる
  - /はChromeによって省略されたものを補完している
- davidを取れるようにしたい
  - request.args.getを使う
- 今日はここまで(18:00)

# 0415

## 講義動画(19:00)
- render_templateの使い方について補足
  - テンプレートで参照する用の変数名=python内の値(変数も可)
- URLを直接いじる形式はやめたい
  - テキストボックス等に入力された値をURLに含めたい
- hello1フォルダ
- form要素のactionでsubmit時のURLを指定できる
  - ルートURL/greet?name=入力値 に移動する(現時点では404)
- /greetにアクセスしたらgreet.htmlを返すよう、greet関数を実装する
  - HTMLファイルはまだ用意されていない
- この時点でsubmitすると500になる(greet.htmlがないので)
- ターミナルにはスタックトレースが表示されている
  - jinja2.exceptions.TemplateNotFound: greet.html
- greet.htmlを作ったら正常に動作した
- nameが空欄のままsubmitするつ「hello,」としか表示されない
  - request.args.get("パラメータ名", デフォルト値) が使える
  - パラメータが無い時にデフォルト値が代入される
  - キーがある場合は何も起こらない
    - 空文字が代入されているとみなされている
- input要素にrequiredをつけて解決した
  - クライアントサイドの入力チェックは信頼できない
  - Devtoolから改変してすり抜けられるので
- index.htmlとgreet.htmlには問題がある
  - 一部が共通している(doctype,html,head等)
  - ファイルが増えると変更の手間も増える
  - 共通点をくくり出したい

## 動画 レイアウト共通化(34:25)
- hello2フォルダ
- templatesフォルダにlayout.htmlを作ってindex.htmlの内容をコピペ
- index.htmlとgreet.htmlは大幅に書き換える
- {% %}でブロックを定義する
- {{}}や{% %}はJinja構文と呼ぶ
  - FlaskはJinja構文を借りている
- app.pyは変更なし
- 実行したら503になってしまった
  - 再実行で問題なく動作
- devtoolで参照するとjinja構文が解消されて完全なHTMLになっていることが分かる
- デザインのよさ(保守しやすさ)とメモリ効率の両方を意識した書き方

## 動画 セキュリティの問題(41:00頃)
- URLから入力値が推測できてしまうのはよくない
  - 名前はともかくパスワード等は漏らしたくない
- index.htmlのform要素のmethod属性をgetからpostに変更するとURLの末尾には載らない
- submitで405(method not allowed)が起きる
- @app.routeの第2引数でメソッドを指定してやる
- 405は解消した
- POSTリクエストのデメリット
  - 履歴やオートコンプリートの有用性が下がる
  - リロード時に不要な更新が行われてしまう可能性がある
  - ブックマークができない
- GETとPOSTはそれぞれ適切に使い分ける必要がある
- 今日はここまで(46:50)

# 0417

## 動画 46:52
- POSTリクエストにしたら名前が取れなくなった
- request.formでリクエストボディを参照できる
  - 使い方はrequest.argsとほぼ同じ
- /greetページを更新するとPOSTリクエストが再送される→正しい結果が表示される
- FlaskはMVCに基づいたフレームワーク
  - app.pyはコントローラに相当する
  - htmlファイルはビューテンプレート(ユーザーインターフェース)
  - 現時点ではモデルがない(CSVやDBを指すことが多い)
- 新たなアプリケーションを作るので現在のコマンドは停止する

## 動画 FroshIMS 50:44
- 下準備
  - app.py
  - templates/layout.html(hello2からコピー)
    - titleタグの中身だけ変えておく
- 学生が学内スポーツに参加するための登録作業を行うらしい
  - 以前は紙で管理していた
- index.htmlもとりあえず用意する
- ファイルを変更するたびにflask runをやり直しているがこれは意味があるんだろうか？
  - こちらの手元ではちゃんと変更が反映されている
  - pset9で再起動を自動化する方法を紹介するらしい
- optionタグにdisabledとselectedをつけるとドロップボックスに簡易的な説明を追加できる
- registerボタンを押した後の処理を実装する
  - まずは入力値チェック
- 動画内の指示に細々したミスがある
  - デモのためか単なる間違いか
- 正しいデータを送ったはずなのにsuccess.htmlが表示されない
  - selectタグで選んだ結果が送れていない？
  - selectタグにname属性をつける必要があった
- devtoolのnetworkタブ(のPayloadタブ)でリクエストボディが参照できる
  - リクエストボディも見えちゃうんならPOSTのセキュリティはちょっと問題がありそう
  - 暗号化してあればいいのかな
- CSSファイルの適用方法
  - layout.htmlのheadにlinkをつけるだけ
  - layoutの中にプレースホルダを用意すると、それぞれのファイルに特定のCSSファイルを適用できる
  - ↑は複雑になりやすいのでクラス名などで判別する方が多い
- selectの中身がハードコートされているのが気になる
  - app.pyでもたせよう
  - pythonに定数という機能はない
  - 変数名を大文字にして区別する慣習
- index.htmlを変更する
  - {% 変数 in リスト %}と{% endfor %}で繰り返しが表現できる
- 今日はここまで(1:13:59)
- ※次回はfroshims1フォルダを編集する

# 0423

## 入力形式の変更 動画(1:13:59)
- セレクトボックスをチェックボックスやラジオボタンに変更する
- なんか503が出たけど時間を置いたら直った
- ラジオボタンの挙動がおかしい
  - ラベルにカーソルが合う感じがする
- ラジオボタンは同じnameの中で1つだけ選ばれるよう調整される

## データの保存 動画(1:16:00)
- 送信したデータを保存できるようにしたい
- froshims3というディレクトリがあるらしい
  - 画面を見ながら作ってみる
  - こういうファイルってあらかじめ配布されているのかな
- 辞書オブジェクトに保存する
- 登録後に一覧画面が表示されるようになった
  - エラー画面も出た
- 辞書オブジェクトはサーバを停止すると中身がなくなってしまう
- 別の方法を使った方がよい
- DBを導入しよう

## DBの導入 動画(1:23:24)
- froshims4
  - また手作業で動画から書き写す必要がある
- sqliteのdbファイルがないと動作しないっぽい？
  - sqlite3 froshims.db でdbファイルを生成できた
  - スキーマも作るしかないかぁ
- create table registrants (id integer, name text not null, sport text not null, primary key(id));
- registrantsテーブルは現時点で空っぽ
- バリデーションがまたfailure.htmlに戻っている
- 関数と変数でそれぞれ同じ名前を使えるのでなんだかもぞもぞする
- registrant.idとregistrant["id"]って何が違うんだっけ
  - プロパティアクセス？辞書オブジェクトの参照？
- またsqliteのプロンプトから抜ける方法を調べた
  - .exit
- 突然コンソールの出力がカラフルになった
  - 実行したSQL文も表示される
- 登録・参照・削除ができることを確認した
  - テーブルにも反映された
- 削除にはユニークなIDを使っている
  - 任意の行が削除されないよう、URLではなくリクエストボディに入れている
  - クロスサイトリクエストフォージェリ
- 今日はここまで(1:34:14)


## 0429

## メール送信機能の追加 動画(1:34:14)
- バージョン5になった
- さすがに複雑すぎる……
  - 見える範囲で書き足したけれどメール送信処理の部分が見えないので分からない
  - DBは使っていないっぽい？
- index.htmlにはEmailの入力欄が増えている
- メールがスパムに振り分けられていた
- import reは何のために追加したんだろう？
- requirements.txtも表示された
  - 今までFlaskも追加しなかったけどどうして動いてたんだろう
  - このファイルには謎が多い

## セッション 動画(1:40:55)
- Webアプリケーションの重要な機能
- ログイン状態やショッピングカートの中身を維持するために使われている
- ステートフル＝状態を持っている
- HTTPはステートレスなプロトコル
- Gmaukを例に考えてみる
- Webサイトを訪問すると、たいていCookieが置かれる
- Cookieはセッションを実現するために必要
  - ログイン状態など大事なものを保持することも、広告のターゲティングに使われることもある
- Cookieは通常とても大きい数字
- その後すべてのリクエストにCookieの値が追加される

## ログイン機能を作る 動画(1:46:44)
- またあらかじめ配布してあるファイルだ(login)
- どこで配布されているんだこれは
  - https://cs50.harvard.edu/x/2023/weeks/9/ のSource Code > zip
  - 年度は違うけど大まかには同じだろう、多分
  - インポートできないのでコピペした
  - 動いた
- index.htmlでJinja構文のifが使われている
  - Jinjaはインデントを気にしない(みやすさのために付けているだけ)
- flask_sessionディレクトリが生成されている
  - 中身のファイルは参照できない
- htmlファイルでもセッションの値は参照できるので、render_templateで渡す必要がなくなる
- NoneはNullと同じ

## ショッピングカートを作る (1:54:29)
- store
- ファイルがインポートできたらな～～～～！
- storeにはdbファイルもあるんだけどこれは移植できない
- 配布されたプロジェクトを見ると、どれもrequirements.txtを用意している
  - なくても動くのか……？
  - TODO 後で調べる
- デモデータにはハリポタ(全7冊)が追加されている
  - さすがに面倒なので適当なタイトルを5個ほど追加しておこう
  - setup.sqlを参照する
- 本のIDはhiddenで持っている
- 同じrouteを指定してPOSTとGETで関数を分けることは出来ないのかな
  - リクエストメソッドで分岐するのはダサく見える
- IN句の中のプレースホルダは1個でよい
  - 適宜区切ってくれる
- この実装だとユーザごとにカートが別れる理屈が謎だけども
  - 変数sessionは宣言せずに使えるっぽい
  - ユーザごとに変数が生成されるのかな

## 最後の例(shows) (2:02:20)
- 具体的な実装よりは動作のメンタルモデルを得るためのプロジェクト
- テレビ番組を検索するプログラム
- LIKEの後は手動で%を追加する必要があるらしい
  - そうだったっけ？
  - Mybatisと混同しているかも
- CREATE TABLE shows (id INTEGER, title TEXT NOT NULL, PRIMARY KEY(id));
- gitリポジトリとしてcloneしてcommit->pushでこっちにもファイルが反映されないかなぁ
- shows1では入力補完的に動作する
  - 検索ボタンがなくなっている
- inputイベントにイベントリスナが追加されている
- fetchの結果としてHTML(の一部)を生成し、ul要素の子に差し込んでいる
- いちいちli要素を生成するのは面倒
  - 検索結果だけを返したい
- show2でさらに改善する(動作はshow1と同じ)
- jsonfy関数で検索結果をJSONとして返している
- pset9ではサードパーティのAPIを使うらしい
- ティッカーシンボル？
  - アメリカの株式銘柄を判別するためのコード
- 講義終わり！

# 0430

## lab
- とりあえず疎通確認と思ったらなぜかtbody内のtr要素がテーブルの外に表示されてしまった
  - tdも足したら直った
  - なんだったんだろう？
- 誕生日は月と日に分かれている
- そんなに難しくなかった
- 入力検証とかした方がいいのかな
  - 要件には含まれないので一旦保留
- リクエストメソッドごとに関数を分けられないか試してみる
  - できたっぽい
  - 関数は増えるけど私はこっちの方がしっくり来るかなぁ
- importが過剰なのは発展的な要件に備えてかな？